#!/bin/sh

if fuser -s /var/lock/aptitude; then true; else
  # update cache then remove downloaded package archives, unused packages, and old config files
  /usr/bin/aptitude update --quiet > /dev/null
  /usr/bin/aptitude clean --quiet > /dev/null
  /usr/bin/aptitude purge --assume-yes --quiet '?garbage' > /dev/null
  /usr/bin/aptitude purge --assume-yes --quiet '?config-files' > /dev/null
fi

<% if desktop -%>
# update-flashplugin-nonfree updates Adobe Flash Player
[ -x /usr/sbin/update-flashplugin-nonfree ] && /usr/sbin/update-flashplugin-nonfree --install --quiet || exit 0
<% end -%>

# debsecan reports packages missing security updates
# report format is not ordinarily quiet (see Debian bug #588065)
umask 077
debsecan_file='/tmp/debsecan'
debsecan_sum='/tmp/debsecan.md5sum'
mailto='security'

debsecan="`/usr/bin/debsecan --suite <%= lsbdistcodename %> --format report --only-fixed`" > /dev/null
if [ -n "$debsecan" ]; then
  if echo "$debsecan" | grep -Fq "No known vulnerabilities for which updates are available"; then
    rm -f "$debsecan_file"
  else
    echo "$debsecan" > "$debsecan_file"
    if [ ! -f "$debsecan_sum" ]; then
      md5sum "$debsecan_file" > "$debsecan_sum"
      echo "$debsecan" | mail -s "Security update: `hostname`" $mailto
    else
      md5sum --check --status "$debsecan_sum" || echo "$debsecan" | mail -s "Security update: `hostname`" $mailto
    fi
  fi
fi
