<VirtualHost *:443>
    ServerName dev.ocf.berkeley.edu
    # TODO: uncomment the below when deploying
    #ServerName www.ocf.berkeley.edu
    #ServerAlias secure.ocf.berkeley.edu ocf.berkeley.edu dev-www.ocf.berkeley.edu dev-ocf.berkeley.edu
    ServerAdmin help@ocf.berkeley.edu

    # canonical hostname is www.ocf.berkeley.edu
    # TODO: undo below changes when deploying
    RewriteEngine on
    RewriteCond %{HTTP_HOST} !^(dev-)?dev\.ocf\.berkeley\.edu$ [NC]
    RewriteRule ^/(.*)$ https://dev.ocf.berkeley.edu/$1 [R=301]

    # proxy to ocfweb...
    # ...but not if it's a userdir
    RewriteCond %{REQUEST_URI} !^/~
    # ...and not if it's a legacy page from the old site
    RewriteCond %{REQUEST_URI} !^/OCF/?$
    RewriteCond %{REQUEST_URI} !^/OCF/index\.shtml$
    RewriteCond %{REQUEST_URI} !^/OCF/motd$
    RewriteCond %{REQUEST_URI} !^/OCF/officers\.shtml$
    RewriteCond %{REQUEST_URI} !^/OCF/past_officers\.shtml$
    RewriteCond %{REQUEST_URI} !^/OCF/staff/index\.shtml$
    RewriteCond %{REQUEST_URI} !^/OCF/staff/where-now\.shtml$
    RewriteCond %{REQUEST_URI} !^/OCF/staff/?$
    # files that need to be around for the old website, but not transferred to ocfweb
    # (these can be removed when all legacy pages above are transferred)
    RewriteCond %{REQUEST_URI} !^/header.html$
    RewriteCond %{REQUEST_URI} !^/footer.html$
    RewriteCond %{REQUEST_URI} !^/skinpicker.html$
    RewriteCond %{REQUEST_URI} !^/tracker.html$
    RewriteCond %{REQUEST_URI} !^/favicon.png$
    RewriteCond %{REQUEST_URI} !^/bleuice.css$
    RewriteCond %{REQUEST_URI} !^/bleuarctic.css$
    RewriteCond %{REQUEST_URI} !^/bkgdwhitepage.gif$
    RewriteCond %{REQUEST_URI} !^/headerbkgdbleuarctic.gif$
    RewriteCond %{REQUEST_URI} !^/ocflogo.png$
    RewriteCond %{REQUEST_URI} !^/ocfbannerbleuarctic.gif$
    RewriteCond %{REQUEST_URI} !^/icon_external.png$
    RewriteCond %{REQUEST_URI} !^/icon_wiki.png$
    RewriteCond %{REQUEST_URI} !^/bkgdwhitefooter.gif$
    RewriteCond %{REQUEST_URI} !^/tabbkgdbleuarctic.gif$
    RewriteCond %{REQUEST_URI} !^/tabbkgdbleuice_hover.gif$
    # TODO: figure out what parts of images/logos are needed, move them to
    # ocfweb and delete the others
    RewriteCond %{REQUEST_URI} !^/images/hosted-logos/?$
    RewriteCond %{REQUEST_URI} !^/images/hosted-logos/index\.shtml$
    # ...and not if it's a special Apache thing (e.g. autoindex icons)
    RewriteCond %{REQUEST_URI} !^/icons/
    RewriteRule ^/(.*)$ http://ocfweb.ocf.berkeley.edu:8001/$1 [P]

    DocumentRoot /srv/sites/ocf/www
    <Directory /srv/sites/ocf/www/>
        DirectoryIndex index.shtml index.html

        # Allow caching of shtml pages
        SSILastModified on

        # Disable .htaccess files
        AllowOverride None
    </Directory>

    LogLevel warn
    ErrorLog ${APACHE_LOG_DIR}/error.log

    CustomLog ${APACHE_LOG_DIR}/ssl_access.log combined

    SSLEngine on
	SSLCertificateFile /etc/ssl/private/<%= @fqdn %>.crt
	SSLCertificateKeyFile /etc/ssl/private/<%= @fqdn %>.key
	SSLCertificateChainFile /etc/ssl/certs/incommon-intermediate.crt
	Include ssl-common.conf

    <FilesMatch "\.(cgi|shtml|phtml|php)$">
        SSLOptions +StdEnvVars
    </FilesMatch>

    Header set Strict-Transport-Security "max-age=31536000"

    Alias /control /srv/sites/control
    <Location /control>
        Options ExecCGI
        AddHandler cgi-script .cgi
    </Location>
</VirtualHost>

# redirect http to https
# TODO: copy this when deploying
#<VirtualHost *:80>
#    ServerName www.ocf.berkeley.edu
#    ServerAlias www ocf.berkeley.edu dev-www.ocf.berkeley.edu dev-ocf.berkeley.edu secure.ocf.berkeley.edu
#    ServerAdmin help@ocf.berkeley.edu
#    CustomLog ${APACHE_LOG_DIR}/access.log combined
#
#    Redirect 301 / https://www.ocf.berkeley.edu/
#</VirtualHost>
