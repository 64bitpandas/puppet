#!/bin/bash -e
# Report changes to the archive since last run. Currently used to email diffs
# to root.

DISTS="wheezy jessie"
ARCHES="amd64 i386"
SUITE="main"

for dist in $DISTS; do
	for arch in $ARCHES; do
		diff_file="/opt/apt/etc/Packages.${dist}_${arch}"
		[ -f "$diff_file" ] || touch "$diff_file"

		# download current Packages and diff with existing
		tmp=$(mktemp)
		packages_url="http://apt/dists/$dist/$SUITE/binary-$arch/Packages"

		wget -qO "$tmp" "$packages_url" || touch "$tmp"
		changes=$(diff -u "$diff_file" "$tmp" || true)

		if [ -n "$changes" ]; then
			echo "Changes to $dist/$SUITE/$arch:"
			echo "$changes"
			echo
			echo

			mv "$tmp" "$diff_file"
		else
			rm "$tmp"
		fi
	done
done
