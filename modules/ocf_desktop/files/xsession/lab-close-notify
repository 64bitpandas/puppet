#!/usr/bin/env python3

import datetime
import sched
import subprocess
import time

from ocflib.lab import hours

# 0 minutes, 2 minute, 5 minutes, 10 minutes, 15 minutes
WARNING_DURATIONS = [0, 120, 300, 600, 900]

def notify_user(seconds_left):
    title = 'Lab closure'
    if seconds_left != 0:
        msg = 'Lab closing in {0:g} minutes'.format(seconds_left / 60)
    else:
        msg = 'The lab is now closed. Please log out and leave right away.'

    # TODO: pick an icon
    subprocess.call(['notify-send', title, msg])

today = datetime.datetime.today()
todays_hours = hours.REGULAR_HOURS[(today.weekday() - 1) % 7]
closing_hours = [x.close for x in todays_hours]

# unix timestamps (seconds since epoch) for the closing times today
closing_times = [datetime.datetime.combine(today.date(), x).timestamp()
        for x in closing_hours]

s = sched.scheduler(time.time)

for t in closing_times:
    for d in WARNING_DURATIONS:
        s.enterabs(t - d, 0, notify_user, argument=(d,))

s.run()
